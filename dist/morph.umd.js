!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("@peter.naydenov/walk")):"function"==typeof define&&define.amd?define(["@peter.naydenov/walk"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).morph=t(e.walk)}(this,(function(e){"use strict";function t(e){return function t(r){const{TG_PRX:o,TG_SFX:a,TG_SIZE_P:i,TG_SIZE_S:s}=e;let l,c,u,f=[];if("string"!=typeof r)return n("notAString");if(0==r.length)return[];if(l=r.indexOf(o),0<l&&f.push(r.slice(0,l)),-1==l)return f.push(r),f;{if(u=r.indexOf(o,l+i),c=r.indexOf(a),-1==c)return n("missingClosing");if(c<l)return n("closedBeforeOpened");if(c+=s,-1!=u&&u<c)return n("newBeforeClosed");f.push(r.slice(l,c));let e=t(r.slice(c));return f.concat(e)}}}function n(e){switch(e){case"notAString":return"Error: Template is not a string.";case"missingClosing":return"Error: Placeholder with missing closing tag.";case"closedBeforeOpened":return"Error: Placeholder closing tag without starting one.";case"newBeforeClosed":return"Error: Nested placeholders. Close placeholder before open new one.";default:return"Error: Unknown template error."}}function r(t,n){const r={};let o=0;if(t instanceof Function)return{dataDeepLevel:0,nestedData:[t()]};if(null==t)return{dataDeepLevel:0,nestedData:[null]};if("string"==typeof t)return{dataDeepLevel:0,nestedData:[t]};if(!n.includes("#"))return{dataDeepLevel:0,nestedData:[t]};return e({data:t,objectCallback:function({key:e,value:t,breadcrumbs:n}){let a=!1;return o=n.split("/").length-1,isNaN(e)||(a=!0),r[o]||(r[o]=a?[]:{}),"root"===e?r[o]=t:a?r[o].push(t):r[o][n]=t,t}}),{dataDeepLevel:o,nestedData:r}}function*o(e,t){let n=function(e={}){let t=[],{type:n,limit:r,onLimit:o}=Object.assign({},{type:"FIFO",limit:!1,onLimit:"update"},e),a="LIFO"===n.toUpperCase(),i=!1;function s(e=1,n=0){let r=[];return n>0&&Array.from({length:n}).map((()=>t.pop())),1==e?t.pop():(Array.from({length:e}).map((()=>{let e=t.pop();null!=e&&r.push(e)})),r)}function l(e=1,n=0){let r=[],o=t.length-n;return e>1&&Array.from({length:e}).map((()=>{null!=t[o-1]&&r.push(t[o-1]),o--})),1==e?t[t.length-1]:r}function c(){}return c.prototype={pull:s,pullReverse:function(e=1,t=0){let n=s(e,t);return n instanceof Array?n.reverse():n},peek:l,peekReverse:function(e=1,t=0){const n=l(e,t);return n instanceof Array?n.reverse():n},getSize:()=>t.length,isEmpty:()=>0==t.length,reset:()=>(t=[],!0),debug:()=>[...t]},c.prototype.push=a?function(e){const n=e instanceof Array,a=n?e.length:1;let l=!1;if("full"!==o||!i){if(r&&n&&a>r&&(e=e.slice(0,-a+r)),r){const a=(n?e.length:1)+t.length;a>=r&&"full"===o&&(e=e.slice(0,-(a-r))),a>=r&&"update"===o&&(l=s(a-r))}return t=e instanceof Array?t.concat(e):t.concat([e]),i=!!r&&t.length===r,l||void 0}}:function(e){const n=e instanceof Array,a=n?e.length:1;let l=!1;if("full"!==o||!i){if(r&&n&&a>r&&(e=e.slice(a-r)),r){const a=(n?e.length:1)+t.length;a>=r&&"full"===o&&(e=e.slice(0,-(a-r))),a>=r&&"update"===o&&(l=s(a-r))}return t=n?e.reduce(((e,t)=>[t,...e]),t):[e].reduce(((e,t)=>[t,...e]),t),i=!!r&&t.length===r,l||void 0}},new c}({type:"LIFO"});for(let r=0;r<=t;r++)n.push(e[r]);for(;n&&!n.isEmpty();){let e=yield n.pull();e&&n.push(e)}}var a={TG_PRX:"{{",TG_SFX:"}}",TG_SIZE_P:2,TG_SIZE_S:2};function i(e){return null==e?"null":"string"==typeof e||"number"==typeof e||"boolean"==typeof e?"primitive":"function"==typeof e?"function":e instanceof Array?"array":e instanceof Object?"object":void 0}function s(e,n,r,...o){e instanceof Object&&Object.entries(e).forEach((([t,n])=>{n instanceof Object&&(e[t]=n.text)}));const i="function"==typeof r[n];return e=function(e={}){return"string"==typeof e?{text:e}:e}(e),i?r[n](e,...o):function(e,n){if(null==n)return null;const r=t(a)(e),o=a;return r.forEach(((e,t)=>{if(e.includes(o.TG_PRX)){const a=e.replace(o.TG_PRX,"").replace(o.TG_SFX,"").trim();n[a]&&(r[t]=n[a])}})),r.join("")}(r[n],e)}function l(n,l=!1,c={}){const{hasError:u,placeholders:f,chop:p,helpers:d,handshake:h}=function(e){const{template:n,helpers:r={},handshake:o}=e,{TG_PRX:i,TG_SFX:s}=a,l=[],c="string"==typeof n?n.replace(/<!--[\s\S]*?-->/g,"").replace(/\s{2,}/g," "):n;let u=null;const f=t(a)(c);return"string"==typeof f?u=f:f.forEach(((e,t)=>{const n=RegExp(i+"\\s*(.*?)\\s*(?::\\s*(.*?)\\s*)?"+s,"g");if(e.includes(i)){const o=n.exec(e);l.push({index:t,data:(r=o[1],r||null),action:o[2]?o[2].split(",").map((e=>e.trim())):null})}var r})),l.forEach((e=>{e.action&&e.action.every((e=>"#"===e||(e.startsWith("?")&&(e=e.replace("?","")),e.startsWith("+")&&(e=e.replace("+","")),e.startsWith("[]")&&(e=e.replace("[]","")),e.startsWith(">")&&(e=e.replace(">","")),""===e||!!r[e]||(u=`Error: Missing helper: ${e}`,!1))))})),{hasError:u,placeholders:l,chop:f,helpers:r,handshake:o}}(n);if(u){function m(){return u}return l?[!1,m]:m}{let y=structuredClone(p);function g(t={},n={},...a){const l=i(t),u=[];if(t=e({data:t}),"null"===l)return y.join("");if("string"==typeof t)switch(t){case"raw":return y.join("");case"demo":if(!h)return"Error: No handshake data.";t=h;break;case"handshake":return h?structuredClone(h):"Error: No handshake data.";case"placeholders":return f.map((e=>y[e.index])).join(", ");default:return`Error: Wrong command "${t}". Available commands: raw, demo, handshake, placeholders.`}return"array"!==l&&(t=[t]),t.forEach((t=>{f.forEach((a=>{const{index:l,data:u,action:f}=a;if(!f&&u){const p=t[u];switch(i(p)){case"function":return void(y[l]=p());case"primitive":return void(y[l]=p);case"array":return void("primitive"===i(p[0])&&(y[l]=p[0]));case"object":return void(p.text&&(y[l]=p.text))}}else{const{dataDeepLevel:h,nestedData:m}=r("@all"===u||null===u||"@root"===u?t:t[u],f),g=o(function(e,t=10){let n={},r=0,o=[...e],a=0;do{n[a]=[],a++}while(a<=t);return o.every((e=>"#"===e?(r++,!(r>t)):e.startsWith("?")?(n[r].push({type:"route",name:e.replace("?",""),level:r}),!0):e.startsWith("+")?(n[r].push({type:"extendedRender",name:e.replace("+",""),level:r}),!0):e.startsWith("[]")?(n[r].push({type:"mix",name:e.replace("[]",""),level:r}),!0):e.startsWith(">")?(n[r].push({type:"data",name:e.replace(">",""),level:r}),!0):(""===e||n[r].push({type:"render",name:e,level:r}),!0))),n}(f,h),h);for(let E of g){let{type:k,name:j,level:x}=E,w=m[x],T=i(w);switch(k){case"route":switch(T){case"array":w.forEach(((e,t)=>{if(null==e)return;const r=i(e),o=d[j](e);null!=o&&("object"===r?w[t].text=s(e,o,d,{...c,...n}):w[t]=s(e,o,d,{...c,...n}))}));break;case"object":w.text=s(w,j,d,{...c,...n});break;case"primitive":m[x]=s(w,j,d,{...c,...n})}break;case"data":switch(T){case"array":w.forEach(((e,t)=>w[t]=e instanceof Function?d[j](e()):d[j](e)));break;case"object":case"primitive":m[x]=d[j](w);break;case"function":m[x]=d[j](w())}break;case"render":const O="function"==typeof d[j];switch(T){case"array":O?w.forEach(((e,t)=>{if(null==e)return;const r=i(e),o=d[j](e,{...c,...n});null==o&&(w[t]=null),"object"===r?e.text=o:w[t]=o})):w.forEach(((e,t)=>{if(null==e)return;const r=i(e),o=s(e,j,d,{...c,...n});null==o&&(w[t]=null),"object"===r?e.text=o:w[t]=o}));break;case"function":m[x]=d[j](w(),{...c,...n});break;case"primitive":m[x]=s(w,j,d,{...c,...n});break;case"object":if(O)m[x].text=d[j](w,{...c,...n});else{Object.keys(w).find((e=>e.includes("/")))?Object.entries(w).forEach((([e,t])=>t.text=s(t,j,d,{...c,...n}))):w.text=s(w,j,d,{...c,...n})}}break;case"extendedRender":"function"==typeof d[j]&&(m[x]=d[j](m[0]));break;case"mix":if(""===j)switch(T){case"object":Object.keys(w).find((e=>e.includes("/")))?Object.entries(w).forEach((([e,t])=>m[x][e]=t.text)):m[x]=w.text;for(let _=x-1;_>=0;_--)m[_]=e({data:m[_],objectCallback:S});function S({value:e,breadcrumbs:t}){return m[x][t]?m[x][t]:e}break;case"array":m[x]=w.map((e=>"object"===i(e)?e.text:e)).filter((e=>null!=e)).join("")}else m[x]=d[j](w)}}let b=i(m[0]),v=m[0];switch(b){case"primitive":if(null==v)return;y[l]=v;break;case"object":if(null==v.text)return;y[l]=v.text;break;case"array":const A=i(v[0]);y[l]="object"===A?v.map((e=>e.text)).join(""):v.join("")}}})),u.push(y.join(""))})),"array"===l?u:a?a.reduce(((e,t)=>"function"!=typeof t?e:t(e,{...c,...n})),u.join("")):u.join("")}return l?[!0,g]:g}}const c={default:{}};return{build:l,get:function(e){if(!(e instanceof Array))return function(){return'Error: Argument "location" is a string. Should be an array. E.g. ["templateName", "storageName"].'};const[t,n="default"]=e;return c[n]?c[n][t]?c[n][t]:function(){return`Error: Template "${t}" does not exist in storage "${n}".`}:function(){return`Error: Storage "${n}" does not exist.`}},add:function(e,t,...n){const[r,o="default"]=e;if(null==t)return void console.warn(`Warning: Template ${o}/${r} is not added to storage. The template is null.`);let a=t,i=!0;if(c[o]||(c[o]={}),"function"!=typeof t){let e=l(t,!0,...n);i=e[0],a=e[1]}i?c[o][r]=a:console.error(`Error: Template "${r}" looks broken and is not added to storage.`)},list:function(e=["default"]){return e.map((e=>c[e]?Object.keys(c[e]):[])).flat()},clear:function(){Object.keys(c).forEach((e=>{"default"!=e?delete c[e]:c.default={}}))},remove:function(e){const[t,n="default"]=e;return c[n]?c[n][t]?void delete c[n][t]:`Error: Template "${t}" does not exist in storage "${n}".`:`Error: Storage "${n}" does not exist.`}}}));
