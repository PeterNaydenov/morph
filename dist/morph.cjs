"use strict";var e=require("@peter.naydenov/walk"),t=require("@peter.naydenov/stack");function r(e){return function t(r){const{TG_PRX:a,TG_SFX:o,TG_SIZE_P:s,TG_SIZE_S:i}=e;let c,l,u,f=[];if("string"!=typeof r)return n("notAString");if(0==r.length)return[];if(c=r.indexOf(a),0<c&&f.push(r.slice(0,c)),-1==c)return f.push(r),f;{if(u=r.indexOf(a,c+s),l=r.indexOf(o),-1==l)return n("missingClosing");if(l<c)return n("closedBeforeOpened");if(l+=i,-1!=u&&u<l)return n("newBeforeClosed");f.push(r.slice(c,l));let e=t(r.slice(l));return f.concat(e)}}}function n(e){switch(e){case"notAString":return"Error: Template is not a string.";case"missingClosing":return"Error: Placeholder with missing closing tag.";case"closedBeforeOpened":return"Error: Placeholder closing tag without starting one.";case"newBeforeClosed":return"Error: Nested placeholders. Close placeholder before open new one.";default:return"Error: Unknown template error."}}function a(t){const r={},n={};let a=0;return e({data:t,objectCallback:function({key:e,value:t,breadcrumbs:r}){let o=!1;return a=r.split("/").length-1,isNaN(e)||(o=!0),n[a]||(n[a]=o?[]:{}),o?n[a].push(t):n[a][r]=t,t},keyCallback:function({key:e,value:t,breadcrumbs:n}){return 0==n.split("/").length-2&&(r[e]=t),t}}),n[0]=r,0==a?{dataDeepLevel:a,nestedData:{0:t}}:{dataDeepLevel:a,nestedData:n}}var o={TG_PRX:"{{",TG_SFX:"}}",TG_SIZE_P:2,TG_SIZE_S:2};function s(e){return null==e?"null":"string"==typeof e||"number"==typeof e||"boolean"==typeof e?"primitive":"function"==typeof e?"function":e instanceof Array?"array":e instanceof Object?"object":void 0}function i(e,t,n){const a="function"==typeof n[t];return"primitive"===s(e)&&(e=function(e={}){return"string"==typeof e?{text:e}:e}(e)),a?n[t](e):function(e,t){if(null==t)return null;const n=r(o)(e),a=o;return n.forEach(((e,r)=>{if(e.includes(a.TG_PRX)){const o=e.replace(a.TG_PRX,"").replace(a.TG_SFX,"").trim();t[o]&&(n[r]=t[o])}})),n.join("")}(n[t],e)}function c(e){const{hasError:n,placeholders:c,chop:l,helpers:u,handshake:f}=function(e){const{template:t,helpers:n,handshake:a}=e,{TG_PRX:s,TG_SFX:i,TG_SIZE_P:c,TG_SIZE_S:l}=o,u=[];let f=null;const p=r(o)(t);return"string"==typeof p?f=p:p.forEach(((e,t)=>{const r=RegExp(s+"\\s*(.*?)\\s*(?::\\s*(.*?)\\s*)?"+i,"g");if(e.includes(s)){const a=r.exec(e);u.push({index:t,data:(n=a[1],n||null),action:a[2]?a[2].split(",").map((e=>e.trim())):null})}var n})),u.forEach((e=>{e.action&&e.action.every((e=>"#"===e||(e.startsWith("!")&&(e=e.replace("!","")),e.startsWith("[]")&&(e=e.replace("[]","")),e.startsWith(">")&&(e=e.replace(">","")),""===e||!!n[e]||(f=`Error: Missing helper: ${e}`,!1))))})),{hasError:f,placeholders:u,chop:p,helpers:n,handshake:a}}(e);if(n)return function(){return n};{let e=structuredClone(l);return function(r={}){const n=s(r),o=[];if("string"==typeof r)switch(r){case"raw":return e.join("");case"demo":if(!f)return"Error: No handshake data.";r=f;break;case"handshake":return f?structuredClone(f):"Error: No handshake data.";case"placeholders":return c.map((t=>e[t.index])).join(", ");default:return`Error: Wrong command "${r}". Available commands: raw, demo, handshake, placeholders.`}return"array"!==n&&(r=[r]),r.forEach((r=>{c.forEach((n=>{const{index:o,data:c,action:l}=n;let f=!0;if(!l&&c){const t=r[c];switch(s(t)){case"primitive":return void(e[o]=t);case"array":return void("primitive"===s(t[0])&&(e[o]=t[0]));case"object":return void(t.text&&(e[o]=t.text))}}else{const{dataDeepLevel:n,nestedData:p}=a("@all"===c||null===c?r:r[c]),d=function*(e,r){let n=t({type:"LIFO"});for(let t=0;t<=r;t++)n.push(e[t]);for(;n&&!n.isEmpty();){let e=yield n.pull();e&&n.push(e)}}(function(e,t=10){let r={},n=0,a=[...e],o=0;do{r[o]=[],o++}while(o<=t);return a.every((e=>"#"===e?(n++,!(n>t)):e.startsWith("!")?(r[n].push({type:"route",name:e.replace("!",""),level:n}),!0):e.startsWith("[]")?(r[n].push({type:"mix",name:e.replace("[]",""),level:n}),!0):e.startsWith(">")?(r[n].push({type:"data",name:e.replace(">",""),level:n}),!0):(""===e||r[n].push({type:"render",name:e,level:n}),!0))),r}(l,n),n),h={};for(let e of d){let t=f?p[n]:h[c],r=s(t),{type:a,name:o}=e;switch(a){case"route":switch(r){case"array":h[c]=t.map((e=>{if(null==e)return null;const t=s(e),r=u[o](e);return null==r||("object"===t?e.text=i(e,r,u):e=i(e,r,u)),e}));break;case"object":h[c].text=i(t,routeName,u);break;case"primitive":h[c]=i(t,routeName,u)}break;case"data":switch(r){case"array":h[c]=t.map((e=>u[o](e)));break;case"object":case"primitive":h[c]=u[o](t)}f=!1;break;case"render":const e="function"==typeof u[o];switch(r){case"array":h[c]=e?t.map((e=>{if(null==e)return null;const t=s(e),r=u[o](e);return null==r?null:("object"===t?e.text=r:e=r,e)})):t.map((e=>{if(null==e)return null;const t=s(e),r=i(e,o,u);return"object"===t?e.text=r:e=r,e}));break;case"primitive":h[c]=i(t,o,u);break;case"object":h[c]=t,h[c].text=i(t,o,u)}f=!1;break;case"mix":if(""===o)switch(r){case"primitive":h[c]=t;break;case"array":h[c]=t.map((e=>"object"===s(e)?e.text:e)).filter((e=>null!=e)).join("");break;case"object":h[c]=t.text}else h[c]=u[o](t);f=!1}}switch(s(h[c])){case"primitive":if(null==h[c])return;e[o]=h[c];break;case"object":if(null==h[c].text)return;e[o]=h[c].text;break;case"array":e[o]=h[c].join("")}}})),o.push(e.join(""))})),"array"===n?o:o.join("")}}}const l={default:{}};const u={build:c,get:function(e,t="default"){return l[t]?l[t][e]?l[t][e]:function(){return`Error: Template "${e}" does not exist in storage "${t}".`}:function(){return`Error: Storage "${t}" does not exist.`}},add:function(e,t,r="default"){let n=t;l[r]||(l[r]={}),"function"!=typeof t&&(n=c(t)),"success"===n.name?l[r][e]=n:console.error(`Error: Template "${e}" looks broken and is not added to storage.`)},list:function(e="default"){return l[e]?Object.keys(l[e]):[]},clear:function(){Object.keys(l).forEach((e=>{"default"!=e?delete l[e]:l.default={}}))},remove:function(e,t="default"){return l[t]?l[t][e]?void delete l[t][e]:`Error: Template "${e}" does not exist in storage "${t}".`:`Error: Storage "${t}" does not exist.`}};module.exports=u;
